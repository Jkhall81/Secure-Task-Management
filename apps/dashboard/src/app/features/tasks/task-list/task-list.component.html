<div
  cdkDropList
  [cdkDropListData]="tasks"
  (cdkDropListDropped)="drop($event)"
  class="space-y-3 min-h-[100px]"
>
  <div
    *ngFor="let task of filteredTasks; trackBy: trackByTaskId"
    cdkDrag
    class="group relative bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all duration-300 cursor-move hover:border-gray-600 hover:scale-[1.02]"
  >
    <!-- Drag handle indicator (visible on hover) -->
    <div
      class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity"
    >
      <svg
        class="w-4 h-4 text-gray-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 8h16M4 16h16"
        ></path>
      </svg>
    </div>

    <!-- Editable Title with Tooltip -->
    <div class="relative pr-6 group/title">
      <h3
        *ngIf="!task.editing"
        class="text-base font-semibold text-white group-hover:text-gray-100 transition-colors line-clamp-2 leading-tight mb-2 cursor-text"
        (dblclick)="enableEditing(task)"
      >
        {{ task.title || 'Untitled Task' }}
      </h3>
      <!-- Tooltip for title -->
      <div
        class="absolute -top-8 left-0 bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover/title:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 border border-gray-700"
      >
        Double click to edit
        <div
          class="absolute -bottom-1 left-3 w-2 h-2 bg-gray-900 transform rotate-45 border-r border-b border-gray-700"
        ></div>
      </div>
      <input
        *ngIf="task.editing"
        [attr.data-task-id]="task.id"
        [(ngModel)]="task.title"
        (blur)="saveTask(task)"
        (keydown.enter)="saveTask(task)"
        (keydown.escape)="cancelEditing(task)"
        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-base font-semibold mb-2 focus:outline-none focus:border-purple-500"
        placeholder="Enter task title..."
      />
    </div>

    <!-- Editable Description with Tooltip -->
    <div class="mb-3">
      <!-- When description exists -->
      <div
        *ngIf="!task.editing && task.description"
        class="relative group/desc"
      >
        <p
          class="text-sm text-gray-300 leading-relaxed cursor-text line-clamp-3 group-hover:text-gray-200 transition-colors"
          (dblclick)="enableEditing(task)"
        >
          {{ task.description }}
        </p>
        <!-- Tooltip for description -->
        <div
          class="absolute -top-8 left-0 bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover/desc:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 border border-gray-700"
        >
          Double click to edit
          <div
            class="absolute -bottom-1 left-3 w-2 h-2 bg-gray-900 transform rotate-45 border-r border-b border-gray-700"
          ></div>
        </div>
      </div>

      <!-- When description is empty -->
      <div
        *ngIf="!task.editing && !task.description"
        class="relative group/empty-desc"
      >
        <div
          class="text-sm text-gray-500 italic cursor-text group-hover:text-gray-400 transition-colors"
          (dblclick)="enableEditing(task)"
        >
          Double-click to add description...
        </div>
        <!-- Tooltip for empty description -->
        <div
          class="absolute -top-8 left-0 bg-gray-900 text-white text-xs py-1 px-2 rounded opacity-0 group-hover/empty-desc:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 border border-gray-700"
        >
          Double click to edit
          <div
            class="absolute -bottom-1 left-3 w-2 h-2 bg-gray-900 transform rotate-45 border-r border-b border-gray-700"
          ></div>
        </div>
      </div>

      <textarea
        *ngIf="task.editing"
        [(ngModel)]="task.description"
        (blur)="saveTask(task)"
        (keydown.escape)="cancelEditing(task)"
        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-gray-300 text-sm resize-none focus:outline-none focus:border-purple-500"
        placeholder="Add a description..."
        rows="3"
      ></textarea>
    </div>

    <!-- Status and metadata -->
    <div
      class="flex items-center justify-between pt-3 border-t border-gray-700/50"
    >
      <!-- Status badge -->
      <span
        class="px-3 py-1.5 text-xs font-medium rounded-full border backdrop-blur-sm transition-all group-hover:scale-105 shrink-0"
        [ngClass]="{
          'bg-purple-500/10 text-purple-300 border-purple-500/30':
            status === 'todo',
          'bg-yellow-500/10 text-yellow-300 border-yellow-500/30':
            status === 'in-progress',
          'bg-green-500/10 text-green-300 border-green-500/30':
            status === 'done'
        }"
      >
        {{ status === 'in-progress' ? 'In Progress' : (status | titlecase) }}
      </span>

      <!-- Badges container - allow wrapping and take available space -->
      <div
        class="flex items-center gap-1 flex-wrap justify-end min-w-0 max-w-[60%]"
      >
        <!-- Category badge -->
        <span
          class="px-2 py-1 text-xs font-medium rounded-full bg-blue-500/10 text-blue-300 border border-blue-500/30 shrink-0"
          *ngIf="task.category"
        >
          {{ task.category | titlecase }}
        </span>

        <!-- Child organization indicator -->
        <span
          *ngIf="task.organization?.parent"
          class="px-2 py-1 text-xs font-medium rounded-full bg-green-500/10 text-green-300 border border-green-500/30 flex items-center gap-1 shrink-0"
          [title]="getChildOrgTooltip(task)"
        >
          <svg class="w-3 h-3 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z"
              clip-rule="evenodd"
            />
          </svg>
          <span class="truncate max-w-[80px]">{{
            task.organization.name
          }}</span>
        </span>
      </div>

      <!-- Right side - timestamp and delete button -->
      <div class="flex items-center gap-2 shrink-0">
        <!-- Optional timestamp -->
        <span
          class="text-xs text-gray-500 group-hover:text-gray-400 transition-colors shrink-0"
        >
          {{ task.createdAt | date : 'MMM d' }}
        </span>

        <!-- Delete button -->
        <button
          (click)="onDelete(task.id)"
          class="p-1.5 text-gray-500 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-all duration-200 opacity-0 group-hover:opacity-100 shrink-0"
          title="Delete task"
        >
          <svg
            class="w-3.5 h-3.5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  <app-confirmation-modal
    *ngIf="showDeleteModal"
    title="Delete Task"
    message="Are you sure you want to delete this task? This action cannot be undone."
    (confirmed)="confirmDelete()"
    (cancelled)="cancelDelete()"
  ></app-confirmation-modal>
</div>
